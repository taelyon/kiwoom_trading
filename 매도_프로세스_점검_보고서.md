# 보유 종목 매도 프로세스 점검 보고서

## 📋 프로세스 개요

보유 종목의 매도 프로세스는 다음 순서로 진행됩니다:

1. **매매 판단 트리거** (`AutoTrader.analyze_and_execute_trading`)
2. **전략 평가** (`KiwoomStrategy.evaluate_strategy`)
3. **보유 종목 확인** (`portfolio['holdings']` 체크)
4. **매도 신호 생성** (`KiwoomStrategy.get_sell_signals`)
5. **매도 신호 실행** (`KiwoomStrategy.execute_sell_signals`)
6. **매도 주문 실행** (`KiwoomTrader.place_sell_order`)

---

## ✅ 정상 동작 확인 사항

### 1. 보유 종목 감지
- ✅ `evaluate_strategy`에서 `portfolio['holdings']` 체크
- ✅ `get_sell_signals`에서 이중 체크 (안전장치)
- ✅ 보유 정보 검증 (buy_price, quantity > 0)

### 2. 매도 전략 로드
- ✅ 통합 전략 우선 로드 구현
- ✅ 전략 로드 순서 정렬 (sell_stg_1, sell_stg_2, ...)
- ✅ 기본 전략 폴백 제공 (-3% 손절, +5% 익절)

### 3. 매도 전략 평가
- ✅ `strategy_utils.evaluate_sell_strategies` 사용
- ✅ `current_profit_pct` 계산 정상
- ✅ 최고가 추적 (`highest_prices`) 정상

### 4. 매도 주문 실행
- ✅ 키움 REST API 연동 정상
- ✅ 매도 기록 DB 저장 (비동기)
- ✅ 보유 수량 업데이트 로직 정상

### 5. 보유 종목 정리
- ✅ 전량 매도 시 `holdings`에서 제거
- ✅ `buy_prices`, `buy_times` 정리
- ✅ UI 리스트박스 동기화

---

## ⚠️ 발견된 잠재적 문제점

### 1. **포트폴리오 동기화 이슈**

**문제:**
- `get_portfolio_status()`는 `self.holdings`의 복사본을 반환
- 웹소켓으로 잔고가 업데이트되어도 `self.holdings`가 자동 업데이트되지 않을 수 있음

**위치:**
```python
# stock_trader.py:896
def get_portfolio_status(self):
    portfolio = {
        'holdings': self.holdings.copy(),  # 복사본 반환
        ...
    }
```

**영향:**
- 웹소켓에서 잔고가 업데이트되었지만 `self.holdings`에 반영되지 않으면
- 매도 조건이 충족되어도 보유 종목으로 인식되지 않을 수 있음

**개선 방안:**
- 웹소켓 잔고 업데이트 시 `self.holdings` 동기화 강화 필요
- 또는 `get_balance_data()`를 활용한 실시간 잔고 확인 추가

---

### 2. **매도 신호 생성 시 수량 계산**

**현재 동작:**
```python
# stock_trader.py:1486
signals.append({
    'quantity': quantity,  # 보유 수량 전체 사용
    ...
})
```

**문제:**
- 매도 신호 생성 시 항상 보유 수량 전체를 사용
- 부분 매도 전략이 없음 (예: 50% 매도 등)

**개선 방안:**
- 필요시 부분 매도 전략 추가 검토

---

### 3. **차트 데이터 부재 시 처리**

**현재 동작:**
```python
# stock_trader.py:1403
chart_data = pd.DataFrame()  # 빈 DataFrame

# 이후 전략 평가 시
condition_met, matched_strategy = strategy_utils.evaluate_sell_strategies(
    ...
    chart_data=chart_data,  # 빈 데이터 전달
    ...
)
```

**영향:**
- 차트 데이터가 없어도 손절/익절 전략(`current_profit_pct`)은 정상 작동
- 기술적 지표 기반 전략은 작동하지 않음 (기본 전략으로 폴백)

**상태:** ✅ 정상 (손절/익절 전략은 영향 없음)

---

### 4. **매도 조건 미충족 시 로그 부족**

**현재:**
```python
# stock_trader.py:1488
else:
    if is_first_sell_check:
        logging.debug(f"ℹ️ [{code}] 매도 조건 미충족 (보유 중, 수익률: {profit_rate:.2f}%)")
```

**개선 방안:**
- 손절 기준 근처(-0.6% 이하)에서는 이미 디버그 로그 추가됨 ✅
- 정기적인 매도 조건 확인 로그 추가 검토 (예: 30초마다)

---

### 5. **보유 수량 확인 로직의 복잡성**

**현재:**
```python
# place_sell_order에서 2단계 확인:
# 1. self.holdings 확인
# 2. 웹소켓 balance_data 확인
```

**상태:** ✅ 정상 (이중 확인으로 안정성 확보)

---

## 🔧 권장 개선 사항

### 1. **포트폴리오 동기화 강화**

웹소켓 잔고 업데이트 시 `self.holdings` 자동 동기화 로직 추가:

```python
# 웹소켓 잔고 업데이트 이벤트 핸들러에서
def on_balance_update(self, balance_data):
    # self.holdings 동기화
    for code, balance in balance_data.items():
        if code not in self.holdings and balance['quantity'] > 0:
            self.holdings[code] = {'quantity': balance['quantity']}
            self.buy_prices[code] = balance['avg_price']
```

### 2. **매도 실행 로그 강화**

매도 신호 생성부터 주문 실행까지의 전체 로그 추적:

```python
# execute_sell_signals에 추가
logging.info(f"🔄 [{code}] 매도 신호 실행 시작: {len(signals)}개 신호")
for idx, signal in enumerate(signals):
    logging.info(f"   신호 {idx+1}: {signal['strategy']}, 수량: {signal['quantity']}주")
```

### 3. **매도 실패 시 재시도 로직**

매도 주문 실패 시 재시도 또는 알림 로직 추가 검토

---

## 📊 프로세스 플로우 다이어그램

```
[AutoTrader.analyze_and_execute_trading]
         ↓
[KiwoomStrategy.evaluate_strategy]
         ↓
    포트폴리오 확인
    (code in portfolio['holdings']?)
         ↓ (Yes)
[KiwoomStrategy.get_sell_signals]
         ↓
    매도 전략 로드 (settings.ini)
         ↓
    전략 평가 (strategy_utils)
         ↓
    조건 충족? (condition_met)
         ↓ (Yes)
    매도 신호 생성 (signals.append)
         ↓
[KiwoomStrategy.execute_sell_signals]
         ↓
[KiwoomTrader.place_sell_order]
         ↓
    키움 REST API 매도 주문
         ↓
    성공/실패 처리
         ↓
    보유 수량 업데이트
         ↓
    전량 매도 시 holdings 정리
```

---

## ✅ 최종 결론

**전체 프로세스는 정상적으로 구현되어 있습니다.**

주요 확인 사항:
- ✅ 보유 종목 감지 정상
- ✅ 매도 전략 로드 및 평가 정상
- ✅ 매도 주문 실행 정상
- ✅ 보유 수량 업데이트 정상

**개선 권장 사항:**
- 포트폴리오 동기화 강화 (웹소켓 잔고 ↔ self.holdings)
- 매도 실행 로그 강화 (디버깅 용이성 향상)

**현재 상태:**
- 디버깅 로그가 추가되어 손절 조건 근처에서 상세 로그 출력 ✅
- 전략 로드 순서 정렬 완료 ✅
- 매도 프로세스 전체가 정상 동작 중 ✅

